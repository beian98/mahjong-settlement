# 麻将筹码结算小程序

基于uni-app开发的线下麻将筹码结算应用，支持多设备实时组局、筹码追踪和智能结算。

## 功能特性

- ✅ **多设备实时组局** - 通过四位数字房间号快速匹配4人
- ✅ **累计筹码制** - 房主自定义初始筹码，追踪每局输赢
- ✅ **筹码平衡校验** - 零和游戏验证，确保收支平衡
- ✅ **游戏结束机制** - 任意玩家筹码≤0时自动结束
- ✅ **智能结算** - 最小化转账次数算法

## 技术栈

- **框架**: uni-app (Vue 3)
- **平台**: 微信小程序
- **状态管理**: Vuex
- **云服务**: 微信云开发（云数据库 + 云函数 + 实时推送）

## 项目结构

```
mahjong-settlement/
├── pages/              # 页面
│   ├── index/         # 首页
│   ├── room/          # 房间系统（创建/加入/大厅）
│   ├── game/          # 游戏记录和结算
│   └── history/       # 历史记录
├── components/        # 组件
├── store/            # Vuex状态管理
├── utils/            # 工具函数
├── models/           # 数据模型
├── cloud/            # 云函数
└── static/           # 静态资源
```

## 快速开始

### 1. 安装依赖

```bash
npm install
```

### 2. 配置微信小程序

#### 2.1 获取AppID

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 注册/登录小程序账号
3. 在「开发」-「开发管理」-「开发设置」中获取 AppID

#### 2.2 配置AppID

编辑 `manifest.json`，将 `mp-weixin.appid` 改为你的AppID：

```json
{
  "mp-weixin": {
    "appid": "你的AppID"
  }
}
```

### 3. 开通微信云开发

1. 在微信开发者工具中打开项目
2. 点击「云开发」按钮
3. 开通云开发环境
4. 获取环境ID

### 4. 配置云开发环境

编辑 `App.vue`，配置云开发环境ID：

```javascript
wx.cloud.init({
  env: 'your-env-id',  // 替换为你的环境ID
  traceUser: true
})
```

### 5. 创建云数据库集合

在微信开发者工具的云开发控制台中创建以下集合：

- **rooms** - 房间信息
  - 索引：roomCode (唯一索引)
  - TTL索引：expireAt (2小时过期)

- **games** - 游戏记录
  - 索引：roomCode, createdAt

- **players** - 玩家信息（可选）
  - 索引：openId

### 6. 部署云函数

```bash
# 在微信开发者工具中右键 cloud 目录
# 选择「上传并部署：云端安装依赖」
```

需要创建的云函数：
- `createRoom` - 创建房间
- `joinRoom` - 加入房间
- `updateRoomStatus` - 更新房间状态
- `deleteRoom` - 删除房间
- `saveGame` - 保存游戏记录

### 7. 运行项目

```bash
# 开发模式
npm run dev:mp-weixin

# 构建生产版本
npm run build:mp-weixin
```

然后在微信开发者工具中打开 `dist/dev/mp-weixin` 目录。

## 核心功能说明

### 房间组局

1. **创建房间**
   - 输入昵称
   - 设置初始筹码（500/1000/2000/自定义）
   - 系统生成四位数字房间号
   - 等待其他玩家加入

2. **加入房间**
   - 输入房间号和昵称
   - 验证房间是否存在且未满
   - 加入房间大厅
   - 4人到齐自动开始游戏

### 游戏流程

1. **记录分数**
   - 显示每个玩家的当前筹码
   - 输入本局输赢分数
   - 实时验证筹码平衡（总和必须为0）
   - 显示本局后的筹码预览
   - 检测是否有玩家筹码≤0

2. **结算**
   - 使用贪心算法计算最少转账次数
   - 显示谁付给谁多少钱
   - 更新每个玩家的筹码余额

3. **游戏结束**
   - 当任意玩家筹码≤0时游戏结束
   - 显示最终排名和盈亏
   - 支持分享结果到微信群

### 筹码追踪

- 每个玩家有初始筹码（房主设置）
- 每局游戏后更新筹码余额
- 实时显示当前筹码和预览
- 筹码≤200时显示警告
- 筹码≤0时游戏结束

## 开发指南

### 数据模型

详见 `models/` 目录：
- `Room.js` - 房间模型
- `Game.js` - 游戏模型
- `Settlement.js` - 结算模型

### 工具函数

详见 `utils/` 目录：
- `roomCode.js` - 房间号生成和验证
- `settlement.js` - 结算算法
- `storage.js` - 本地存储封装
- `cloud.js` - 云开发API封装（待实现）
- `share.js` - 微信分享功能（待实现）

### 云函数

详见 `cloud/` 目录，每个云函数需要包含：
- `index.js` - 云函数入口
- `package.json` - 依赖配置

## 待实现功能

根据实现计划，以下功能需要继续开发：

- [ ] 房间创建页面
- [ ] 房间加入页面
- [ ] 房间大厅页面（实时监听）
- [ ] 游戏记录页面（筹码追踪）
- [ ] 结算结果页面
- [ ] 最终结算页面
- [ ] 历史记录页面
- [ ] 云函数实现
- [ ] 微信分享功能
- [ ] 实时数据同步

## 测试

### 本地测试

在微信开发者工具中测试：
1. 测试页面导航
2. 测试本地存储
3. 测试UI交互

### 多设备测试

需要至少2台设备测试：
1. A创建房间，B/C/D依次加入
2. 4人同时加入同一房间
3. 游戏中一人��网后重连
4. 筹码追踪和游戏结束机制

## 常见问题

### 1. 云开发初始化失败

确保已在 `App.vue` 中正确配置环境ID，并在微信开发者工具中开通云开发。

### 2. 实时数据推送不工作

检查云数据库权限配置，确保 rooms 集合允许所有用户读写。

### 3. 房间号重复

createRoom 云函数会自动检查房间号唯一性，如果重复会重新生成。

## 许可证

MIT

## 参考文档

- [uni-app 官方文档](https://uniapp.dcloud.net.cn/)
- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [微信云开发文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
